<project_specification>
  <project_name>Luminous - Next-Gen Integrated Planning & Program Review Platform</project_name>

  <overview>
    Build "Luminous," an AI-enhanced Program Review and Integrated Planning platform for Los Angeles Mission College (LAMC) / LACCD. The application serves as a "System of Engagement" that overlays existing "Systems of Record" (eLumen, PeopleSoft). It prioritizes User Experience (UX) and AI Assistance using **Google Gemini 2.5 Flash** to reduce the cognitive load of data analysis and report writing for faculty. The platform transforms compliance-driven Program Review into meaningful institutional improvement by embedding equity analytics, enforcing ACCJC accreditation standards, and creating a "Golden Thread" linking Mission -> Strategic Plan -> Program Goal -> Resource Request.
  </overview>

  <technology_stack>
    <frontend>
      <framework>Next.js (React)</framework>
      <styling>Tailwind CSS</styling>
      <state_management>Zustand or React Context</state_management>
      <routing>Next.js App Router</routing>
      <markdown>React Markdown for message rendering</markdown>
      <charts>Chart.js or Recharts for data visualization</charts>
    </frontend>
    <backend>
      <runtime>Python with FastAPI</runtime>
      <database>
        **Neon (Serverless Postgres)** using **SQLModel** (SQLAlchemy).
        For local/VPS development, use a standard Postgres 16+ container in Docker Compose if Neon is not directly accessible, but the target production DB is Neon.
      </database>
      <ai_integration>
        **Google Gen AI SDK** using **Gemini 2.5 Flash** (or `gemini-2.5-flash-lite`) for high-speed, low-cost inference.
      </ai_integration>
      <rag>
        **Gemini API File Search** for retrieving institutional context (ACCJC standards, handbooks).
        Documents are uploaded/indexed into a File Search Store.
      </rag>
    </backend>
    <authentication>
      <provider>**Firebase Authentication** (Email/Password)</provider>
      <implementation>
        - Frontend: Firebase JS SDK for login/signup
        - Backend: `firebase-admin` SDK for verifying ID tokens in API dependencies
      </implementation>
      <user_management>
        - Seed initial users (Faculty, Chair, Dean, Admin) manually via script
        - Map Firebase UIDs to local `users` table in Postgres
      </user_management>
    </authentication>
    <deployment>
      <hosting>**Docker Compose** on VPS</hosting>
      <containerization>
        - `frontend` service (Node.js)
        - `backend` service (Python/FastAPI)
        - `db` service (Postgres 16 - strictly for local/VPS dev env)
      </containerization>
    </deployment>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Google AI API Key (exported as `GOOGLE_API_KEY`)
      - Firebase Project created with Authentication enabled (Email/Pass)
      - `serviceAccountKey.json` for Firebase Admin SDK placed in `/backend`
      - `.env` file containing:
        - `DATABASE_URL` (Neon connection string or local postgres)
        - `GOOGLE_API_KEY`
        - `GEMINI_FILE_SEARCH_STORE_NAME` (ID of the indexed store)
    </environment_setup>
  </prerequisites>

  <reference_data>
    <description>
      The following reference materials are available for building and testing the application.
      These contain real institutional data, accreditation standards, and detailed requirements.
    </description>

    <accjc_documents path="../ACCJC/">
      - ACCJC-2024-Accreditation-Standards.pdf
      - Eligibility-Requirements-for-Accreditation.pdf
      - Various policy documents
      **Action:** These must be indexed into the Gemini File Search Store during initialization.
    </accjc_documents>

    <course_data path="../reference_data/">
      - la_mission_PPM_Published_Map_Export_2025-2026_10-15-2025.csv
      - LAC_SRC_COURSE_MASTER_11492.xlsx
      - NEW LAMC GE and Cal-GETC GE 2025-2026.xlsx
      **Action:** Use this data to seed the `courses`, `enrollments`, and `slo_data` tables in Postgres.
    </course_data>

    <prd_documents path="../reference_data/">
      - PRD_comprehensive.md
      - PRD_revision2.md
      - PRD_revision3.md
    </prd_documents>
  </reference_data>

  <core_features>
    <program_review_template_designer>
      - Template versioning for "Instructional," "Student Services," "Administrative," and "CTE" units
      - **JSONB Column in Postgres:** Store the flexible form schema and user responses in a `content` JSONB column within the `program_reviews` table.
      - Embedded live data widgets between narrative text prompts
      - Curriculum currency widget
    </program_review_template_designer>

    <context_aware_editor>
      - "Smart Context" editor powered by Gemini 2.5 Flash
      - Data injection: Auto-fetch program success/retention data
      - **Gemini Analysis:** Click "Analyze Trends" -> System sends data + prompt to Gemini -> returns bullet points
      - "Expand to Narrative": AI rewrites bullets into academic prose
    </context_aware_editor>

    <equity_lens_assistant>
      - Pre-submission "Equity Check" button
      - AI analyzes text against ACCJC Standards using RAG (File Search)
      - Flags unaddressed demographic gaps
    </equity_lens_assistant>

    <integrated_planning_goal_setting>
      - Goal Mapping: **Relational Link** between `action_plans` and `strategic_initiatives` tables
      - Visual display of "Golden Thread"
    </integrated_planning_goal_setting>

    <resource_allocation_management>
      - **Relational Table:** `resource_requests` table with foreign key to `action_plans`
      - "Amazon Cart" experience
      - Object Code validation (1000-6000 series)
      - Total Cost of Ownership (TCO) calculator
    </resource_allocation_management>

    <compliance_copilot>
      - Sidebar chatbot ("Mission-Bot")
      - **Implementation:** Uses `google.genai.Client` with `tools=[file_search_tool]`
      - Queries the indexed ACCJC/Institutional documents
    </compliance_copilot>

    <workflow_governance>
      - State machine managed via `status` column in `program_reviews` table
      - RBAC enforced via `users.role` and Firebase Custom Claims (optional) or DB lookup
    </workflow_governance>
  </core_features>

  <database_schema>
    <type>Relational (Postgres) using SQLModel</type>
    <tables>
      <users>
        - id: UUID (PK)
        - firebase_uid: String (Unique, Indexed)
        - email: String
        - full_name: String
        - role: Enum (Faculty, Chair, Dean, Admin, PROC)
        - department_id: Foreign Key -> organizations.id
      </users>

      <organizations>
        - id: UUID (PK)
        - name: String
        - type: Enum (College, Division, Department)
        - parent_id: Foreign Key -> organizations.id (Self-referential)
      </organizations>

      <strategic_initiatives>
        - id: UUID (PK)
        - code: String (e.g., "1.1")
        - description: Text
        - active: Boolean
      </strategic_initiatives>

      <program_reviews>
        - id: UUID (PK)
        - org_id: Foreign Key -> organizations.id
        - author_id: Foreign Key -> users.id
        - cycle_year: String (e.g., "2025-2026")
        - status: Enum (Draft, In Review, Validated, Approved)
        - **content**: JSONB (Stores the dynamic form data/narratives)
        - created_at: DateTime
        - updated_at: DateTime
      </program_reviews>

      <action_plans>
        - id: UUID (PK)
        - review_id: Foreign Key -> program_reviews.id
        - title: String
        - description: Text
        - equity_gap_addressed: Boolean
      </action_plans>

      <action_plan_mappings>
        - id: UUID (PK)
        - action_plan_id: Foreign Key -> action_plans.id
        - initiative_id: Foreign Key -> strategic_initiatives.id
      </action_plan_mappings>

      <resource_requests>
        - id: UUID (PK)
        - action_plan_id: Foreign Key -> action_plans.id
        - object_code: String
        - amount: Decimal
        - justification: Text
        - priority: Enum
        - is_funded: Boolean
      </resource_requests>

      <documents>
        - id: UUID (PK)
        - filename: String
        - gemini_file_uri: String (URI in Google Gen AI)
        - uploaded_at: DateTime
      </documents>
    </tables>
  </database_schema>

  <api_endpoints_summary>
    <auth>
      - POST /api/auth/login (Verify Firebase Token, return User profile)
      - POST /api/auth/seed (Dev only: Seed initial users)
    </auth>

    <program_reviews>
      - GET /api/reviews (List by Dept/User)
      - POST /api/reviews (Create new)
      - GET /api/reviews/{id}
      - PATCH /api/reviews/{id} (Update JSON content)
      - POST /api/reviews/{id}/submit
    </program_reviews>

    <ai>
      - POST /api/ai/analyze (Gemini 2.5 Flash analysis)
      - POST /api/ai/expand (Gemini 2.5 Flash rewriting)
      - POST /api/ai/chat (Gemini 2.5 Flash + File Search for Compliance Copilot)
    </ai>

    <resources>
      - POST /api/resources (Add request)
      - GET /api/resources/summary (For Budget Committee)
    </resources>
  </api_endpoints_summary>

  <implementation_steps>
    <step number="1">
      <title>Setup Project & Docker</title>
      <tasks>
        - Create `docker-compose.yml` with Backend, Frontend, and Postgres services
        - Initialize Git repo
        - Create `requirements.txt` and `package.json`
      </tasks>
    </step>

    <step number="2">
      <title>Database & Schema</title>
      <tasks>
        - Define SQLModel classes (Users, Reviews, etc.)
        - Configure Alembic for migrations
        - Create seed script for Organizations and Users
      </tasks>
    </step>

    <step number="3">
      <title>Gemini Integration</title>
      <tasks>
        - Implement `GeminiService` class using `google-genai`
        - Create script to upload ACCJC PDFs to Gemini File Search
        - Save `file_search_store_name` to .env
      </tasks>
    </step>

    <step number="4">
      <title>Backend API Core</title>
      <tasks>
        - Implement Firebase Token verification dependency
        - Build CRUD endpoints for Program Reviews
        - Implement JSONB handling for review content
      </tasks>
    </step>

    <step number="5">
      <title>Frontend Foundation</title>
      <tasks>
        - Setup Next.js with Tailwind
        - Create Firebase Login page
        - Build Dashboard layout
      </tasks>
    </step>

    <step number="6">
      <title>Feature: Program Review Editor</title>
      <tasks>
        - Build dynamic form renderer
        - Connect "Smart Context" AI features
        - Implement "Save Draft" (PATCH JSON content)
      </tasks>
    </step>

    <step number="7">
      <title>Feature: Resource & Planning</title>
      <tasks>
        - Build Action Plan & Resource Request tables/UI
        - Implement "Golden Thread" linking logic
      </tasks>
    </step>
  </implementation_steps>
</project_specification>